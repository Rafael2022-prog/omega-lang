name: ðŸš€ OMEGA Native Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: ðŸ“¦ Create Native Release
    runs-on: ubuntu-latest

    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.changelog.outputs.VERSION }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ðŸ“¦ Build and Package VS Code Extension
      run: |
        cd omega-vscode-extension
        npm ci
        npm run compile
        npx vsce package
        cd ..

    - name: ðŸ—ï¸ Build OMEGA Native
      run: |
        pwsh -ExecutionPolicy Bypass -File build_omega_native.ps1 -Clean

    - name: âœ… Test Native Build
      run: |
        pwsh -ExecutionPolicy Bypass -File scripts/simple_test.ps1 -SkipBuild

    - name: ðŸ”Ž Detect VS Code Extension VSIX (optional)
      id: vsix
      shell: bash
      run: |
        if compgen -G "omega-vscode-extension/*.vsix" > /dev/null; then
          P=$(ls omega-vscode-extension/*.vsix | head -n 1)
          N=$(basename "$P")
          echo "has=true" >> $GITHUB_OUTPUT
          echo "path=$P" >> $GITHUB_OUTPUT
          echo "name=$N" >> $GITHUB_OUTPUT
        else
          echo "has=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“ Generate changelog
      id: changelog
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate changelog for native OMEGA
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## OMEGA Native $VERSION" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸš€ Native Features" >> $GITHUB_OUTPUT
        echo "- Pure native OMEGA compiler implementation" >> $GITHUB_OUTPUT
        echo "- Cross-platform PowerShell-based tooling" >> $GITHUB_OUTPUT
        echo "- No external dependencies (Rust/Node.js free)" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ› Bug Fixes" >> $GITHUB_OUTPUT
        echo "- Bug fixes and improvements" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ“š Documentation" >> $GITHUB_OUTPUT
        echo "- Documentation updates" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ðŸ”§ Technical Changes" >> $GITHUB_OUTPUT
        echo "- Internal improvements and refactoring" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**Full Changelog**: https://github.com/Rafael2022-prog/omega-lang/compare/v1.0.0...$VERSION" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ðŸ“¦ Create release assets
      shell: bash
      run: |
        set -e
        mkdir -p release-assets
        
        # Copy VS Code extension if exists
        if compgen -G "omega-vscode-extension/*.vsix" > /dev/null; then
          cp omega-vscode-extension/*.vsix release-assets/
        else
          echo "No VSIX found, skipping copy to release-assets."
        fi
        
        # Create source archive
        git archive --format=zip --prefix=omega-lang-${{ steps.changelog.outputs.VERSION }}/ HEAD > release-assets/omega-lang-${{ steps.changelog.outputs.VERSION }}-source.zip
        
        # Create installation scripts archive
        zip -r release-assets/omega-lang-${{ steps.changelog.outputs.VERSION }}-install-scripts.zip install/ scripts/

    - name: ðŸš€ Create GitHub Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: OMEGA ${{ steps.changelog.outputs.VERSION }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}

    - name: ðŸ“¤ Upload VS Code Extension (if present)
      if: steps.vsix.outputs.has == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.vsix.outputs.path }}
        asset_name: ${{ steps.vsix.outputs.name }}
        asset_content_type: application/octet-stream

    - name: ðŸ” Compute VSIX checksum (SHA256)
      if: steps.vsix.outputs.has == 'true'
      id: vsix_checksum
      shell: bash
      run: |
        set -e
        FILE="${{ steps.vsix.outputs.path }}"
        HASH=$(sha256sum "$FILE" | awk '{print $1}')
        echo "$HASH  $(basename \"$FILE\")" > "${FILE}.sha256"
        echo "checksum_path=${FILE}.sha256" >> $GITHUB_OUTPUT

    - name: ðŸ“¤ Upload VSIX checksum
      if: steps.vsix.outputs.has == 'true'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.vsix_checksum.outputs.checksum_path }}
        asset_name: ${{ steps.vsix.outputs.name }}.sha256
        asset_content_type: text/plain

    - name: ðŸ“¤ Upload Source Archive
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/omega-lang-${{ steps.changelog.outputs.VERSION }}-source.zip
        asset_name: omega-lang-${{ steps.changelog.outputs.VERSION }}-source.zip
        asset_content_type: application/zip

    - name: ðŸ“¤ Upload Installation Scripts
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-assets/omega-lang-${{ steps.changelog.outputs.VERSION }}-install-scripts.zip
        asset_name: omega-lang-${{ steps.changelog.outputs.VERSION }}-install-scripts.zip
        asset_content_type: application/zip

  publish-vscode:
    name: ðŸ“¦ Publish VS Code Extension
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: |
        cd omega-vscode-extension
        npm ci

    - name: ðŸš€ Publish to VS Code Marketplace
      run: |
        cd omega-vscode-extension
        npx vsce publish -p ${{ secrets.VSCE_TOKEN }}

    - name: ðŸš€ Publish to Open VSX Registry
      run: |
        cd omega-vscode-extension
        npx ovsx publish -p ${{ secrets.OVSX_TOKEN }}

  notify-community:
    name: ðŸ“¢ Notify Community
    runs-on: ubuntu-latest
    needs: [create-release, publish-vscode, native-binaries]
    if: always() && needs.create-release.result == 'success'

    steps:
    - name: ðŸ“¢ Post to Discord (if configured)
      if: secrets.DISCORD_WEBHOOK_URL
      run: |
        curl -H "Content-Type: application/json" \
             -X POST \
             -d '{
               "embeds": [{
                 "title": "ðŸš€ New OMEGA Release!",
                 "description": "OMEGA ${{ github.ref_name }} has been released!",
                 "color": 5814783,
                 "fields": [
                   {
                     "name": "Version",
                     "value": "${{ github.ref_name }}",
                     "inline": true
                   },
                   {
                     "name": "Download",
                     "value": "[GitHub Releases](https://github.com/Rafael2022-prog/omega-lang/releases/latest)",
                     "inline": true
                   }
                 ],
                 "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
               }]
             }' \
             ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: ðŸ“§ Send email notification (if configured)
      if: secrets.SMTP_SERVER
      run: |
        echo "New OMEGA release ${{ github.ref_name }} is available!" | \
        mail -s "OMEGA ${{ github.ref_name }} Released" \
             -S smtp=${{ secrets.SMTP_SERVER }} \
             -S smtp-auth=login \
             -S smtp-auth-user=${{ secrets.SMTP_USER }} \
             -S smtp-auth-password=${{ secrets.SMTP_PASSWORD }} \
             ${{ secrets.NOTIFICATION_EMAIL }}

  update-documentation:
    name: ðŸ“š Update Documentation
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“ Update version in documentation
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        
        # Update version in README
        sed -i "s/Version: [0-9]\+\.[0-9]\+\.[0-9]\+/Version: $VERSION/g" README.md
        
        # Update version in docs
        find docs/ -name "*.md" -exec sed -i "s/version [0-9]\+\.[0-9]\+\.[0-9]\+/version $VERSION/g" {} \;

    - name: ðŸ’¾ Commit version updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "ðŸ“ Update documentation for release ${{ github.ref_name }}"
        git push

  sync-wiki:
    name: ðŸ”„ Sync Wiki after Release
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
    uses: ./.github/workflows/sync-wiki.yml
    secrets:
      WIKI_PAT: ${{ secrets.WIKI_PAT }}
    with:
      only_md: true
      file_glob: ""
      mapping_file: "wiki/mapping.json"

  native-binaries:
    name: ðŸ“¦ Upload Native Binaries
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PowerShell (Linux/macOS)
        if: runner.os != 'Windows'
        uses: ./.github/actions/setup-powershell

      - name: ðŸ—ï¸ Build OMEGA Native
        shell: pwsh
        run: |
          pwsh -ExecutionPolicy Bypass -File omega_native.ps1

      - name: ðŸ“¦ Package native binary
         id: pack
         shell: pwsh
         run: |
           $ErrorActionPreference = 'Stop'
           New-Item -ItemType Directory -Force -Path 'release-assets' | Out-Null
           $bin = 'omega.exe'
           if (-not (Test-Path $bin)) { $bin = 'omega' }
           if (-not (Test-Path $bin)) { throw 'Binary not found: omega(.exe)' }
           $platform = $env:RUNNER_OS
           $osArch = [System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture
           switch ($osArch) {
             'X64'   { $arch = 'x64' }
             'Arm64' { $arch = 'arm64' }
             default { $arch = $osArch.ToString().ToLower() }
           }
           switch ($platform) {
             'Windows' { $plat = "windows-$arch" }
             'macOS'   { $plat = "macos-$arch" }
             'Linux'   { $plat = "linux-$arch" }
             default   { $plat = $platform.ToLower() }
           }
           $version = '${{ needs.create-release.outputs.version }}'
           $assetName = "omega-native-$plat-$version.zip"
           $zipPath = Join-Path 'release-assets' $assetName
           Compress-Archive -Path $bin -DestinationPath $zipPath -Force
           Write-Host "Packaged $bin -> $zipPath"
           # Generate checksum
           $hash = Get-FileHash -Algorithm SHA256 -Path $zipPath
           $checksumPath = "$zipPath.sha256"
           "$($hash.Hash)  $assetName" | Out-File -FilePath $checksumPath -Encoding ascii
           "asset_path=$zipPath" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8
           "asset_name=$assetName" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8
           "checksum_path=$checksumPath" | Out-File -Append -FilePath $env:GITHUB_OUTPUT -Encoding utf8

      - name: ðŸ“¤ Upload native binary
         uses: actions/upload-release-asset@v1
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
           upload_url: ${{ needs.create-release.outputs.upload_url }}
           asset_path: ${{ steps.pack.outputs.asset_path }}
           asset_name: ${{ steps.pack.outputs.asset_name }}
           asset_content_type: application/zip

       - name: ðŸ“¤ Upload checksum (SHA256)
         uses: actions/upload-release-asset@v1
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
           upload_url: ${{ needs.create-release.outputs.upload_url }}
           asset_path: ${{ steps.pack.outputs.checksum_path }}
           asset_name: ${{ steps.pack.outputs.asset_name }}.sha256
           asset_content_type: text/plain