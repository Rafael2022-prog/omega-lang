name: ðŸ§ª OMEGA Cross-Platform Test Workflow

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/**'
      - 'ide/**'
      - 'omega-vscode-extension/**'
      - 'homebrew-tap/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/**'
      - 'ide/**'
      - 'omega-vscode-extension/**'
      - 'homebrew-tap/**'

jobs:
  omega_tests:
    name: OMEGA Tests (${\{ matrix.os \}})
    runs-on: ${\{ matrix.os \}}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup PowerShell (Linux/macOS)
        if: runner.os != 'Windows'
        uses: ./.github/actions/setup-powershell

      - name: â›” Skip external CLI install (pure native policy)
        run: |
          echo "Skipping npm/choco installs to align with pure native compiler"
        shell: bash

      - name: ðŸ§ª Run native integration tests (if available)
        shell: pwsh
        run: |
          if (Test-Path './omega.exe') {
            Write-Host "Running integration tests with native omega.exe"
            ./omega.exe test tests/integration_tests.mega
          } else {
            Write-Host "omega.exe not present; skipping native tests" -ForegroundColor Yellow
          }

      - name: ðŸ”Ž Compute version for artifact naming
        uses: ./.github/actions/compute-version

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: omega-test-results-${{ matrix.os }}-${{ env.OMEGA_VERSION_NAME }}
          path: |
            test-reports/
            **/*.log
          if-no-files-found: warn