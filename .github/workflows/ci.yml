name: ğŸš€ OMEGA Native CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª Native OMEGA Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PowerShell (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          # Install PowerShell on Ubuntu
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
        elif [ "$RUNNER_OS" == "macOS" ]; then
          # Install PowerShell on macOS
          brew install --cask powershell
        fi

    - name: ğŸš€ Build Self-Hosting Compiler
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
          .\omega_native.ps1
        else
          echo "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
          pwsh -File omega_native.ps1
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: âœ… Verify Self-Hosting Capability
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          if (Test-Path "omega.exe") {
            Write-Host "âœ… OMEGA self-hosting binary created successfully"
            .\omega.exe --version
            Write-Host "ğŸ”„ Testing self-compilation..."
            .\omega.exe compile src/self_hosting_compiler.mega --target native
          } else {
            Write-Host "âŒ Self-hosting build failed"
            exit 1
          }
        else
          if [ -f "omega.exe" ]; then
            echo "âœ… OMEGA self-hosting binary created successfully"
            pwsh -c ".\omega.exe --version"
            echo "ğŸ”„ Testing self-compilation..."
            pwsh -c ".\omega.exe compile src/self_hosting_compiler.mega --target native"
          else
            echo "âŒ Self-hosting build failed"
            exit 1
          fi
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ§ª Run Self-Hosting Test Suite
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ§ª Running self-hosting test suite..."
          .\omega.exe test tests/self_hosting_test_suite.mega
        else
          echo "ğŸ§ª Running self-hosting test suite..."
          pwsh -c ".\omega.exe test tests/self_hosting_test_suite.mega"
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ§ª Run Legacy Test Suite (Compatibility)
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          powershell -ExecutionPolicy Bypass -File scripts/simple_test.ps1 -SkipBuild
        else
          chmod +x scripts/simple_test.ps1
          pwsh -ExecutionPolicy Bypass -File scripts/simple_test.ps1 -SkipBuild
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: |
          test-reports/
          *.log

  self_hosting_validation:
    name: ğŸ”„ Self-Hosting Validation
    runs-on: ubuntu-latest
    needs: [test]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PowerShell
      run: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https software-properties-common
        wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update
        sudo apt-get install -y powershell

    - name: ğŸš€ Build Self-Hosting Compiler
      run: |
        echo "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
        pwsh -File omega_native.ps1

    - name: ğŸ”„ Multi-Stage Self-Compilation Test
      run: |
        echo "ğŸ”„ Stage 1: Initial self-compilation..."
        pwsh -c ".\omega.exe compile src/self_hosting_compiler.mega --target native --output omega_stage1.exe"
        
        echo "ğŸ”„ Stage 2: Self-compilation with stage 1 binary..."
        pwsh -c ".\omega_stage1.exe compile src/self_hosting_compiler.mega --target native --output omega_stage2.exe"
        
        echo "ğŸ”„ Stage 3: Verification - both binaries should be identical..."
        if cmp -s omega_stage1.exe omega_stage2.exe; then
          echo "âœ… Self-hosting validation successful - binaries are identical"
        else
          echo "âŒ Self-hosting validation failed - binaries differ"
          exit 1
        fi

    - name: ğŸ¯ Cross-Target Compilation Test
      run: |
        echo "ğŸ¯ Testing EVM target compilation..."
        pwsh -c ".\omega.exe compile contracts/SimpleToken.mega --target evm --output SimpleToken.sol"
        
        echo "ğŸ¯ Testing Solana target compilation..."
        pwsh -c ".\omega.exe compile contracts/SimpleToken.mega --target solana --output lib.rs"
        
        echo "âœ… Cross-target compilation successful"

    - name: ğŸ“Š Upload self-hosting artifacts
      uses: actions/upload-artifact@v4
      with:
        name: self-hosting-artifacts
        path: |
          omega_stage1.exe
          omega_stage2.exe
          SimpleToken.sol
          lib.rs

  lint:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..
        cd omega-vscode-extension && npm ci && cd ..

    - name: ğŸ” Run ESLint (LSP Server)
      run: |
        cd lsp-server
        npx eslint . --ext .js,.ts --format json --output-file ../eslint-results.json || true
        cd ..

    - name: ğŸ” Run ESLint (VS Code Extension)
      run: |
        cd omega-vscode-extension
        npx eslint . --ext .js,.ts --format json --output-file ../eslint-extension-results.json || true
        cd ..

    - name: ğŸ“Š Upload lint results
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: |
          eslint-results.json
          eslint-extension-results.json

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..
        cd omega-vscode-extension && npm ci && cd ..

    - name: ğŸ”’ Run npm audit (LSP Server)
      run: |
        cd lsp-server
        npm audit --audit-level moderate --json > ../audit-lsp.json || true
        cd ..

    - name: ğŸ”’ Run npm audit (VS Code Extension)
      run: |
        cd omega-vscode-extension
        npm audit --audit-level moderate --json > ../audit-extension.json || true
        cd ..

    - name: ğŸ“Š Upload security results
      uses: actions/upload-artifact@v4
      with:
        name: security-results
        path: |
          audit-lsp.json
          audit-extension.json

  build:
    name: ğŸ—ï¸ Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..
        cd omega-vscode-extension && npm ci && cd ..

    - name: ğŸ—ï¸ Build VS Code extension
      run: |
        cd omega-vscode-extension
        npm run compile
        cd ..

    - name: ğŸ“¦ Package VS Code extension
      run: |
        cd omega-vscode-extension
        npx vsce package
        cd ..

    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}
        path: |
          omega-vscode-extension/*.vsix

  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..

    - name: âš¡ Run performance benchmarks
      run: |
        chmod +x scripts/performance_benchmark.sh
        ./scripts/performance_benchmark.sh

    - name: ğŸ“Š Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: test-reports/performance/

  coverage:
    name: ğŸ“Š Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..
        cd omega-vscode-extension && npm ci && cd ..

    - name: ğŸ“Š Generate coverage report
      run: |
        # Run tests with coverage
        chmod +x scripts/simple_test.ps1
        ./scripts/simple_test.ps1

    - name: ğŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [test, self_hosting_validation, lint, security, build]
    if: always()

    steps:
    - name: ğŸ“¢ Notify on success
      if: needs.test.result == 'success' && needs.self_hosting_validation.result == 'success' && needs.lint.result == 'success' && needs.security.result == 'success' && needs.build.result == 'success'
      run: |
        echo "âœ… All checks passed! Self-hosting compiler validated successfully."
        echo "ğŸš€ OMEGA v1.2.0 Self-Hosting Milestone achieved!"

    - name: ğŸ“¢ Notify on failure
      if: needs.test.result == 'failure' || needs.self_hosting_validation.result == 'failure' || needs.lint.result == 'failure' || needs.security.result == 'failure' || needs.build.result == 'failure'
      run: |
        echo "âŒ Some checks failed. Please review the results."
        if [ "${{ needs.self_hosting_validation.result }}" == "failure" ]; then
          echo "ğŸ”„ Self-hosting validation failed - check compiler implementation"
        fi
        exit 1