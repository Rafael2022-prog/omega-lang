name: ğŸš€ OMEGA Native CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: ğŸ§ª Native OMEGA Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PowerShell
      if: runner.os != 'Windows'
      uses: ./.github/actions/setup-powershell

    - name: ğŸš€ Build Self-Hosting Compiler
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
          .\omega_native.ps1
        else
          echo "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
          pwsh -File omega_native.ps1
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: âœ… Verify Self-Hosting Capability
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          if (Test-Path "omega.exe") {
            Write-Host "âœ… OMEGA self-hosting binary created successfully"
            .\omega.exe --version
            Write-Host "ğŸ”„ Testing self-compilation..."
            .\omega.exe compile src/self_hosting_compiler.mega --target native
          } else {
            Write-Host "âŒ Self-hosting build failed"
            exit 1
          }
        else
          if [ -f "omega.exe" ]; then
            echo "âœ… OMEGA self-hosting binary created successfully"
            pwsh -c ".\omega.exe --version"
            echo "ğŸ”„ Testing self-compilation..."
            pwsh -c ".\omega.exe compile src/self_hosting_compiler.mega --target native"
          else
            echo "âŒ Self-hosting build failed"
            exit 1
          fi
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ§ª Run Self-Hosting Test Suite
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ§ª Running self-hosting test suite..."
          .\omega.exe test tests/self_hosting_test_suite.mega
        else
          echo "ğŸ§ª Running self-hosting test suite..."
          pwsh -c ".\omega.exe test tests/self_hosting_test_suite.mega"
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ§ª Run Legacy Test Suite (Compatibility)
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          powershell -ExecutionPolicy Bypass -File scripts/simple_test.ps1 -SkipBuild
        else
          chmod +x scripts/simple_test.ps1
          pwsh -ExecutionPolicy Bypass -File scripts/simple_test.ps1 -SkipBuild
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ env.OMEGA_VERSION_NAME }}
        path: |
          test-reports/
          *.log
        if-no-files-found: warn

  self_hosting_validation:
    name: ğŸ”„ Self-Hosting Validation
    runs-on: ubuntu-latest
    needs: [test]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell

    - name: ğŸš€ Build Self-Hosting Compiler
      run: |
        echo "ğŸ—ï¸ Building OMEGA self-hosting compiler..."
        pwsh -File omega_native.ps1

    - name: ğŸ”„ Multi-Stage Self-Compilation Test
      run: |
        echo "ğŸ”„ Stage 1: Initial self-compilation..."
        pwsh -c ".\omega.exe compile src/self_hosting_compiler.mega --target native --output omega_stage1.exe"
        
        echo "ğŸ”„ Stage 2: Self-compilation with stage 1 binary..."
        pwsh -c ".\omega_stage1.exe compile src/self_hosting_compiler.mega --target native --output omega_stage2.exe"
        
        echo "ğŸ”„ Stage 3: Verification - both binaries should be identical..."
        if cmp -s omega_stage1.exe omega_stage2.exe; then
          echo "âœ… Self-hosting validation successful - binaries are identical"
        else
          echo "âŒ Self-hosting validation failed - binaries differ"
          exit 1
        fi

    - name: ğŸ¯ Cross-Target Compilation Test
      run: |
        echo "ğŸ¯ Testing EVM target compilation..."
        pwsh -c ".\omega.exe compile contracts/SimpleToken.mega --target evm --output SimpleToken.sol"
        
        echo "ğŸ¯ Testing Solana target compilation..."
        pwsh -c ".\omega.exe compile contracts/SimpleToken.mega --target solana --output lib.rs"
        
        echo "âœ… Cross-target compilation successful"

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload self-hosting artifacts
      uses: actions/upload-artifact@v4
      with:
        name: self-hosting-artifacts-${{ env.OMEGA_VERSION_NAME }}
        path: |
          omega_stage1.exe
          omega_stage2.exe
          SimpleToken.sol
          lib.rs
        if-no-files-found: warn

  cross_platform_build:
    name: ğŸ—ï¸ Cross-Platform Native Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        architecture: [x86_64, arm64]
        exclude:
          - os: windows-latest
            architecture: arm64  # GitHub Actions doesn't support Windows ARM64 yet

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup PowerShell
      if: runner.os != 'Windows'
      uses: ./.github/actions/setup-powershell

    - name: ğŸš€ Build Cross-Platform OMEGA Compiler
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ—ï¸ Building cross-platform OMEGA compiler..."
          .\omega.exe compile build_cross_platform.mega --target native --output omega_cross_platform.exe
        else
          echo "ğŸ—ï¸ Building cross-platform OMEGA compiler..."
          # For Linux/macOS, compile the cross-platform build script
          pwsh -c "if (Test-Path 'omega.exe') { .\omega.exe compile build_cross_platform.mega --target native --output omega_cross_platform } else { echo 'OMEGA compiler not found, using bootstrap' }"
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ§ª Test Cross-Platform Compilation
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          Write-Host "ğŸ§ª Testing cross-platform compilation for Windows..."
          if (Test-Path "omega_cross_platform.exe") {
            .\omega_cross_platform.exe
          } else {
            Write-Host "âš ï¸ Cross-platform compiler not available yet"
          }
        else
          echo "ğŸ§ª Testing cross-platform compilation for ${RUNNER_OS}..."
          if [ -f "omega_cross_platform" ]; then
            chmod +x omega_cross_platform
            ./omega_cross_platform
          else
            echo "âš ï¸ Cross-platform compiler not available yet"
          fi
        fi
      shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload cross-platform artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cross-platform-${{ matrix.os }}-${{ matrix.architecture }}-${{ env.OMEGA_VERSION_NAME }}
        path: |
          target/cross-platform/
          omega_cross_platform*
        if-no-files-found: warn

  lint:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies (VS Code Extension)
      run: |
        cd ide/vscode-extension
        npm ci
        cd ../..

    - name: ğŸ” Run ESLint (VS Code Extension)
      run: |
        cd ide/vscode-extension
        npm run lint -- --format json --output-file ../../eslint-extension-results.json || true
        cd ../..

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell
 
    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload lint results
      uses: actions/upload-artifact@v4
      with:
        name: lint-results-${{ env.OMEGA_VERSION_NAME }}
        path: |
          eslint-extension-results.json
        if-no-files-found: warn

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell
 
    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload lint results
      uses: actions/upload-artifact@v4
      with:
        name: lint-results-${{ env.OMEGA_VERSION_NAME }}
        path: |
          eslint-results.json
          eslint-extension-results.json
        if-no-files-found: warn

  vscode-extension-test:
    name: ğŸ§ª VS Code Extension Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd ide/vscode-extension
        npm ci
        cd ../..

    - name: ğŸ§ª Run VS Code extension tests
      run: |
        cd ide/vscode-extension
        npm test
        cd ../..

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vscode-extension-test-results-${{ matrix.os }}-${{ env.OMEGA_VERSION_NAME }}
        path: |
          ide/vscode-extension/test-reports/
          ide/vscode-extension/*.log
        if-no-files-found: warn

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd ide/vscode-extension
        npm ci
        cd ../..

    - name: ğŸ”’ Run npm audit (VS Code Extension)
      run: |
        cd ide/vscode-extension
        npm audit --audit-level moderate --json > ../audit-extension.json || true
        cd ../..

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell
 
    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload security results
      uses: actions/upload-artifact@v4
      with:
        name: security-results-${{ env.OMEGA_VERSION_NAME }}
        path: |
          audit-extension.json
        if-no-files-found: warn

  build:
    name: ğŸ—ï¸ Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd ide/vscode-extension
        npm ci
        cd ../..

    - name: ğŸ—ï¸ Build VS Code extension
      run: |
        cd ide/vscode-extension
        npm run compile
        cd ../..

    - name: ğŸ“¦ Package VS Code extension
      run: |
        cd ide/vscode-extension
        npx vsce package
        cd ../..

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell
 
    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}-${{ env.OMEGA_VERSION_NAME }}
        path: |
          ide/vscode-extension/*.vsix
        if-no-files-found: warn

  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd lsp-server && npm ci && cd ..

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell
 
    - name: âš¡ Run performance benchmarks
      shell: pwsh
      run: |
        ./scripts/quick_benchmark.ps1

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results-${{ env.OMEGA_VERSION_NAME }}
        path: test-reports/performance/
        if-no-files-found: warn

  coverage:
    name: ğŸ“Š Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd ide/vscode-extension
        npm ci
        cd ../..

    - name: ğŸ”§ Setup PowerShell
      uses: ./.github/actions/setup-powershell

    - name: ğŸ“Š Generate coverage report (VS Code Extension)
      run: |
        cd ide/vscode-extension
        npm run test:coverage || npm test
        cd ../..

    - name: ğŸ“¤ Upload coverage to Codecov
      if: ${{ hashFiles('ide/vscode-extension/coverage/lcov.info') != '' }}
      uses: codecov/codecov-action@v3
      with:
        file: ./ide/vscode-extension/coverage/lcov.info
        flags: vscode-extension
        name: codecov-vscode-extension

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ env.OMEGA_VERSION_NAME }}
        path: coverage/**
        if-no-files-found: warn

  audit_tools:
    name: ğŸ” Audit Tools Integration
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Dependency Audit (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/dependency_audit.ps1

    - name: ğŸ” Security Scan (Ubuntu)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        chmod +x scripts/security_scan.sh
        ./scripts/security_scan.sh

    - name: ğŸ” Compute version for artifact naming (Windows)
      if: runner.os == 'Windows'
      uses: ./.github/actions/compute-version

    - name: ğŸ” Setup PowerShell (Linux)
      if: runner.os != 'Windows'
      uses: ./.github/actions/setup-powershell

    - name: ğŸ” Compute version for artifact naming (Linux)
      if: runner.os != 'Windows'
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload audit artifacts
      uses: actions/upload-artifact@v4
      with:
        name: audit-results-${{ matrix.os }}-${{ env.OMEGA_VERSION_NAME }}
        path: |
          security-reports/
          audit-*.json
        if-no-files-found: warn

  compile_smoke:
    name: ğŸ§ª Compile Smoke (Windows)
    runs-on: windows-latest
    needs: [test]
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Build native compiler (Windows)
      shell: pwsh
      run: |
        pwsh -NoProfile -ExecutionPolicy Bypass -File omega_native.ps1

    - name: ğŸ§ª Run compile-only smoke tests
      shell: pwsh
      run: |
        pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/compile_smoke.ps1

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“¦ Upload compile smoke artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compile-smoke-windows-${{ env.OMEGA_VERSION_NAME }}
        path: |
          security-reports/
          audit-*.json
          test-reports/
          *.log
        if-no-files-found: warn

  http_version_check:
    name: ğŸŒ HTTP /version Check (Windows)
    runs-on: windows-latest
    needs: [test]
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Build native compiler (Windows)
      shell: pwsh
      run: |
        pwsh -NoProfile -ExecutionPolicy Bypass -File omega_native.ps1

    - name: âœ… Verify HTTP /version endpoint
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $proc = Start-Process -FilePath 'pwsh' -ArgumentList '-NoProfile','-ExecutionPolicy','Bypass','-File','scripts/omega_native_runner.ps1','-Port','8099','-BindHost','127.0.0.1' -PassThru
        try {
          Start-Sleep -Seconds 3
          $resp = Invoke-WebRequest 'http://127.0.0.1:8099/version' -UseBasicParsing
          $content = $resp.Content
          $content | Out-File -Encoding utf8 -FilePath 'http-version-check.log'
          Write-Host "Status: $($resp.StatusCode)"
          Write-Host "Body: $content"
          $json = $content | ConvertFrom-Json
          if (-not $json.compiler_version) {
            throw "compiler_version missing in response"
          }
        } finally {
          if ($proc -and (Get-Process -Id $proc.Id -ErrorAction SilentlyContinue)) {
            Stop-Process -Id $proc.Id -Force
          }
        }

    - name: ğŸ” Compute version for artifact naming
      uses: ./.github/actions/compute-version

    - name: ğŸ“Š Upload HTTP version check logs
      uses: actions/upload-artifact@v4
      with:
        name: http-version-check-${{ env.OMEGA_VERSION_NAME }}
        path: |
          http-version-check.log
        if-no-files-found: warn

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [test, self_hosting_validation, lint, security, build, audit_tools, compile_smoke, http_version_check]
    if: always()

    steps:
    - name: ğŸ“¢ Notify on success
      if: needs.test.result == 'success' && needs.self_hosting_validation.result == 'success' && needs.lint.result == 'success' && needs.security.result == 'success' && needs.build.result == 'success' && needs.audit_tools.result == 'success' && needs.compile_smoke.result == 'success'
      run: |
        echo "âœ… All checks passed! Self-hosting compiler validated successfully."
        BASE_VERSION="$(head -n 1 VERSION | tr -d '\r')"
        [ -z "$BASE_VERSION" ] && BASE_VERSION="1.3.0"
        META="ci.${GITHUB_RUN_NUMBER}.${GITHUB_SHA::7}"
        FULL_VERSION="${BASE_VERSION}-${META}"
        echo "ğŸš€ OMEGA ${FULL_VERSION} Self-Hosting Milestone achieved!"

    - name: ğŸ“¢ Notify on failure
      if: needs.test.result == 'failure' || needs.self_hosting_validation.result == 'failure' || needs.lint.result == 'failure' || needs.security.result == 'failure' || needs.build.result == 'failure' || needs.audit_tools.result == 'failure' || needs.compile_smoke.result == 'failure'
      run: |
        echo "âŒ Some checks failed. Please review the results."
        if [ "${{ needs.self_hosting_validation.result }}" == "failure" ]; then
          echo "ğŸ”„ Self-hosting validation failed - check compiler implementation"
        fi
        exit 1