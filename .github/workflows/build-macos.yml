# OMEGA macOS Build Configuration for CI/CD
# Builds on macOS for both Intel and Apple Silicon

name: Build OMEGA - macOS
on: [push, pull_request]

jobs:
  build-macos-intel:
    runs-on: macos-12
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          echo "ðŸ“¦ Installing build tools..."
          brew install gcc make --quiet
      
      - name: Build C bootstrap (Intel)
        run: |
          echo "ðŸ“¦ Building C bootstrap for Intel macOS..."
          gcc-13 -std=c99 -Wall -Wextra -O2 \
            -o bootstrap/omega_minimal \
            bootstrap/omega_minimal.c
          echo "âœ… C bootstrap compiled for Intel"
      
      - name: Build OMEGA compiler (Intel)
        run: |
          echo "ðŸ”¨ Building OMEGA for macOS Intel..."
          ./bootstrap/omega_minimal src/lexer/lexer.mega
          ./bootstrap/omega_minimal src/parser/parser.mega
          ./bootstrap/omega_minimal src/semantic/analyzer.mega
          ./bootstrap/omega_minimal src/codegen/codegen.mega
          ./bootstrap/omega_minimal src/optimizer/optimizer.mega
          echo "âœ… OMEGA modules bootstrapped for Intel"
      
      - name: Link OMEGA executable (Intel)
        run: |
          echo "ðŸ”— Linking OMEGA for Intel..."
          gcc-13 -o target/omega \
            target/lexer.o \
            target/parser.o \
            target/semantic.o \
            target/codegen.o \
            target/optimizer.o
          chmod +x target/omega
          echo "âœ… OMEGA linked for Intel"
      
      - name: Test OMEGA (Intel)
        run: |
          echo "ðŸ§ª Testing OMEGA on Intel macOS..."
          ./target/omega --version
          ./target/omega --help
          echo "âœ… Intel macOS tests passed"
      
      - name: Build distribution (Intel)
        run: |
          echo "ðŸ“¦ Building macOS Intel distribution..."
          mkdir -p dist/omega-macos-intel
          cp target/omega dist/omega-macos-intel/
          cp README.md dist/omega-macos-intel/
          tar -czf omega-2.0.0-macos-intel.tar.gz -C dist omega-macos-intel/
      
      - name: Upload Intel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: omega-macos-intel
          path: dist/omega-macos-intel/

  build-macos-arm64:
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build tools
        run: |
          echo "ðŸ“¦ Installing build tools..."
          brew install gcc make --quiet
      
      - name: Build C bootstrap (ARM64)
        run: |
          echo "ðŸ“¦ Building C bootstrap for Apple Silicon..."
          gcc-13 -std=c99 -Wall -Wextra -O2 \
            -o bootstrap/omega_minimal \
            bootstrap/omega_minimal.c
          echo "âœ… C bootstrap compiled for Apple Silicon"
      
      - name: Build OMEGA compiler (ARM64)
        run: |
          echo "ðŸ”¨ Building OMEGA for macOS ARM64..."
          ./bootstrap/omega_minimal src/lexer/lexer.mega
          ./bootstrap/omega_minimal src/parser/parser.mega
          ./bootstrap/omega_minimal src/semantic/analyzer.mega
          ./bootstrap/omega_minimal src/codegen/codegen.mega
          ./bootstrap/omega_minimal src/optimizer/optimizer.mega
          echo "âœ… OMEGA modules bootstrapped for ARM64"
      
      - name: Link OMEGA executable (ARM64)
        run: |
          echo "ðŸ”— Linking OMEGA for ARM64..."
          gcc-13 -o target/omega \
            target/lexer.o \
            target/parser.o \
            target/semantic.o \
            target/codegen.o \
            target/optimizer.o
          chmod +x target/omega
          echo "âœ… OMEGA linked for ARM64"
      
      - name: Test OMEGA (ARM64)
        run: |
          echo "ðŸ§ª Testing OMEGA on Apple Silicon..."
          ./target/omega --version
          ./target/omega --help
          echo "âœ… Apple Silicon tests passed"
      
      - name: Build distribution (ARM64)
        run: |
          echo "ðŸ“¦ Building macOS ARM64 distribution..."
          mkdir -p dist/omega-macos-arm64
          cp target/omega dist/omega-macos-arm64/
          cp README.md dist/omega-macos-arm64/
          tar -czf omega-2.0.0-macos-arm64.tar.gz -C dist omega-macos-arm64/
      
      - name: Upload ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: omega-macos-arm64
          path: dist/omega-macos-arm64/

  test:
    needs: [build-macos-intel, build-macos-arm64]
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Intel artifacts
        uses: actions/download-artifact@v4
        with:
          name: omega-macos-intel
      
      - name: Download ARM64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: omega-macos-arm64
      
      - name: Verify executables
        run: |
          echo "âœ… macOS build completed successfully"

  release:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: macos-14
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create universal binary
        run: |
          echo "ðŸ”— Creating universal macOS binary..."
          lipo -create \
            omega-macos-intel/omega \
            omega-macos-arm64/omega \
            -output omega-universal
          chmod +x omega-universal
          echo "âœ… Universal binary created"
      
      - name: Create release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: OMEGA ${{ github.ref }}
          draft: false
          prerelease: false